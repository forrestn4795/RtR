<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Ready to Relate</title>
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <!-- Gen Z-friendly font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
      :root {
        --fg:#333333;         /* Charcoal text */
        --muted:#333333;      /* All text requested charcoal */
        --bg1:#E7D6F7;        /* Gradient start (soft lavender) */
        --bg2:#CBB2FF;        /* Gradient end (pastel purple) */
        --card:#FFD166;       /* Warm yellow for cards/boxes */
        --accent:#06D6A0;     /* Mint green for accents/buttons/progress fill */
        --accent-soft:#BFF3E8;/* Soft mint background for progress shell */
        --border:#d9b458;     /* Slightly darker yellow border */
        --ink:#333333;
        --link:#5b43ff;
      }
      html, body { height: 100%; }
      body {
        margin:0;
        font-family: 'Inter', ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
        color:var(--fg);
        background: linear-gradient(135deg, var(--bg1), var(--bg2));
        background-attachment: fixed;
      }
      a { color: var(--link); }
      .wrap { max-width: 960px; margin: 0 auto; padding: 28px 24px 40px; }
      h1 { font-size: 40px; font-weight: 800; letter-spacing: -0.02em; margin: 0 0 6px; }
      p.hook {
        margin: 0 0 18px;
        font-size: 18px;
        font-weight: 600;
      }
      p.lead { margin: 0 0 24px; opacity: 0.9; }
      .highlight {
        font-weight: 800;
        background: rgba(255,255,255,0.85);
        padding: 2px 8px;
        border-radius: 8px;
      }
      .inline-links { display:inline-flex; gap:12px; align-items:center; margin-left:8px; }
      .card {
        background: var(--card);
        border: 1px solid var(--border);
        border-radius: 18px;
        padding: 20px;
        box-shadow: 0 4px 20px rgba(0,0,0,.08);
        margin-bottom: 16px;
      }
      .row { padding: 12px 0; border-bottom: 1px solid rgba(0,0,0,.08); }
      .row:last-child { border-bottom: 0; }
      .q { margin-bottom: 10px; font-weight: 600; }
      .grid { display: grid; grid-template-columns: repeat(5, minmax(0,1fr)); gap: 8px; }
      .btn {
        border: 1px solid #07c59a;
        background: #ffffff;
        border-radius: 12px;
        padding: 10px 0;
        cursor: pointer;
        font-weight: 600;
      }
      .btn:hover { box-shadow: 0 2px 8px rgba(0,0,0,.08); }
      .btn.sel { background: var(--accent); color: #fff; border-color: var(--accent); }
      .sub { font-size: 12px; margin-top: 6px; }
      .controls { display:flex; gap: 8px; margin: 20px 0; flex-wrap: wrap; }
      .btn2 {
        border:1px solid #07c59a;
        background:#ffffff;
        border-radius:12px;
        padding:10px 14px;
        cursor:pointer;
        font-weight: 600;
      }
      .btn2.primary { background: var(--accent); color:#fff; }
      .btn2:disabled { opacity:.5; cursor:not-allowed; }
      .btn2:hover { box-shadow: 0 2px 10px rgba(0,0,0,.08); }
      .progress {
        height: 18px;                             /* bigger progress bar */
        background: var(--accent-soft);           /* soft mint shell */
        border-radius:999px;
        overflow:hidden;
        box-shadow: inset 0 0 0 1px #8de3d4;
      }
      .progress > div {
        height:100%;
        background: var(--accent);                /* mint fill */
        transition: width .2s ease;
      }
      .results .big { font-size: 44px; font-weight: 800; }
      .flex { display:flex; justify-content: space-between; align-items:center; gap:16px; }
      .meter {
        margin: 8px 0 16px;
        height: 10px;                             /* slightly bigger */
        background:#f6e3a6;                       /* soft yellow track */
        border-radius:999px;
        overflow:hidden;
      }
      .meter > div { height:100%; background:#7c5cff; } /* purple fill for subscale bars */
      footer { font-size:12px; margin: 24px 0; opacity: .9; }
      .pill { display:inline-block; font-size:12px; padding:4px 10px; border-radius: 999px; border:1px solid #07c59a; background:#fff; }
      .hidden { display:none; }
      details { margin-top: 12px; }
      details > summary { cursor: pointer; user-select: none; color: #5b43ff; font-weight: 600; }
      .note { font-size: 12px; margin-top: 10px; }
      .callout { border-left: 3px solid #5b43ff; padding-left: 10px; margin-top: 8px; }
      .grid2 { display:grid; grid-template-columns: 1fr 1fr 1fr; gap: 12px; }
      label { font-size: 12px; display:block; margin-bottom:6px; font-weight:600; }
      input[type="number"], select {
        width: 100%;
        border:1px solid #cbb37a;
        border-radius:10px;
        padding:10px;
        background:#fff;
        color:var(--ink);
      }
      .warn { color:#b91c1c; font-size:12px; }
      .inline-note { font-size: 12px; color: #5b43ff; margin-left: 8px; user-select: none; }
      .inline-check { display:flex; align-items:center; gap:8px; margin-top:6px; }
      .badge { display:flex; gap:12px; align-items:center; margin-top:8px; flex-wrap:wrap; }
      .code {
        font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        font-size: 20px;
        padding: 6px 10px;
        border:1px dashed #cbb37a;
        border-radius: 10px;
        background:#fff6cf;
      }
      .muted { font-size: 12px; }
      .ok { color:#16a34a; }
      .err { color:#b91c1c; }
      .decodeGrid { display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-top:6px; }
      .verdict { margin-top:8px; padding:8px 10px; border-left:4px solid rgba(0,0,0,.15); background:#fff6cf; border-radius:8px; }
      .v-good { border-left-color:#06D6A0; }
      .v-medium { border-left-color:#5b43ff; }
      .v-poor { border-left-color:#e07a1f; }

      /* Download section */
      .dl-row { display:flex; gap:8px; flex-wrap:wrap; margin-top:8px; }
      .dl-row select { padding:10px; border-radius:10px; border:1px solid #cbb37a; background:#fff; }

      /* Preview */
      .previewWrap { position: relative; margin-top:10px; }
      #badgePreviewCanvas { display:block; width:100%; height:auto; border-radius:16px; border:1px solid var(--border); }
      .blurred { filter: blur(6px) grayscale(.15); }

      /* Tips */
      #tipsList { margin-top:8px; padding-left: 16px; }
      #tipsList li { margin-bottom:6px; }
    </style>
  <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-57YB15FB25"></script>
<script>
      // --- Analytics flags ---
      var GA_SURVEY_STARTED = false;
      var GA_SURVEY_COMPLETED = false;

  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-57YB15FB25');
  function gaEvent(name, params){ try { gtag('event', name, params || {}); } catch(e){} }
</script>
  </head>
  <body>
    <div class="wrap">
      <h1>Ready to Relate</h1>
      <p class="hook">Find out how ready you REALLY are for love — and prove it to others.</p>
      <p class="lead">
        Answer all 24 questions. Each choice has a unique score (1–5). When you finish, you’ll
        see a readiness score and an evidence-based 6‑month estimate adjusted for your age (18–39), city dating pool,
        and time since your last serious relationship. <span class="highlight">Everything runs in your browser</span>.
        <span class="inline-links"><a href="#" id="privacyLink">Privacy</a><a href="#" id="whoLink">Who we are</a></span>
      </p>

      <div class="card">
        <div class="grid2">
          <div>
            <label for="age">Your age (18–39) <span class="warn">*</span></label>
            <input id="age" type="number" min="18" max="39" placeholder="e.g., 28" required aria-required="true" />
            <div id="ageWarn" class="warn hidden">Please enter an age between 18 and 39.</div>
          </div>
          <div>
            <label for="city">Your city <span class="inline-note" aria-hidden="true">More cities coming</span></label>
            <select id="city">
              <option value="NATIONAL">Use national baseline</option>
            </select>
          </div>
          <div>
            <label for="pool">Your usual dating pool</label>
            <select id="pool">
              <option value="womanSeekingMan">Woman seeking men (uses men-per-100-women)</option>
              <option value="manSeekingWoman">Man seeking women (uses women-per-100-men)</option>
            </select>
          </div>
        </div>
        <div style="margin-top:12px">
          <label for="monthsSince">Months since your last serious relationship ended (optional)</label>
          <input id="monthsSince" type="number" min="0" max="240" placeholder="e.g., 6 for half a year" />
          <div class="inline-check">
            <input id="initiator" type="checkbox" />
            <label for="initiator" style="margin:0">I ended the last relationship (applies only within the first year)</label>
          </div>
        </div>
      </div>

      <div class="card">
        <div class="progress"><div id="progressBar" style="width:0%"></div></div>
        <div class="sub"><span id="answeredCount">0</span> / <span id="totalItems">24</span> answered</div>
      </div>

      <div id="questionBlocks" class="card"></div>

      <div class="controls">
        <button class="btn2" id="toTop">Back to top</button>
        <button class="btn2" id="resetBtn">Clear answers</button>
        <span class="pill" id="statusPill">Incomplete</span>
      </div>

      <!-- Results now visible from start -->
      <div id="resultsCard" class="card results">
        <h2 style="margin:0 0 8px">Your Results</h2>
        <div class="sub">The overall score is mapped to bands below. Open the breakdown if you want details.</div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px">
          <div>
            <div class="big" id="readinessScore">—</div>
            <div class="sub" id="readinessLabel">Start answering to see your score</div>
            <div class="sub" id="readinessBand">—</div>
          </div>
          <div>
            <div class="sub"><strong>Band definitions</strong></div>
            <ul class="sub" style="margin-top:6px">
              <li><span id="lbl-ready"></span></li>
              <li><span id="lbl-unsure"></span></li>
              <li><span id="lbl-notready"></span></li>
            </ul>
          </div>
        </div>

        <details id="breakdown" class="">
          <summary>Show detailed breakdown (optional)</summary>
          <div id="subscaleMeters"></div>
        </details>

        <div class="callout" id="probabilityLine" style="margin-top:12px">Enter your age to unlock the estimate.</div>
        <div class="note" id="pairNote"></div>

        <div class="card" style="margin-top:12px">
          <div class="flex">
            <div>
              <strong>Shareable RfR code (5‑digits)</strong>
              <div class="muted">Encodes your six subscale levels (1–5 each). Same levels → same code.</div>
            </div>
            <button class="btn2" id="copyCode">Copy</button>
          </div>
          <div class="badge">
            <span class="code" id="badgeCode">00000</span>
            <span class="muted" id="badgeExplain"></span>
          </div>

          <!-- Visible badge preview (blurred until completion) -->
          <div class="previewWrap">
            <canvas id="badgePreviewCanvas" width="1080" height="1080" class="blurred"></canvas>
          </div>

          <!-- Badge download & variant controls -->
          <div class="dl-row">
            <label for="badgeVariant" style="margin:0; align-self:center;">Badge style:</label>
            <select id="badgeVariant">
              <option value="auto">Auto (based on your results)</option>
              <option value="one_area">High in one specific area</option>
              <option value="all_high">All-around high</option>
              <option value="all_medium">All-around medium</option>
              <option value="all_low">All-around low</option>
            </select>
            <button class="btn2 primary" id="dlStory" disabled>Download PNG – Story (1080×1920)</button>
            <button class="btn2 primary" id="dlSquare" disabled>Download PNG – Square (1080×1080)</button>
            <button class="btn2 primary" id="dlWide" disabled>Download PNG – Horizontal (1600×900)</button>
          </div>
          <canvas id="badgeCanvas" class="hidden" width="1080" height="1080"></canvas>
        </div>

        <!-- Tips section -->
        <div id="tipsCard" class="card" style="margin-top:12px;">
          <strong>Tips to improve</strong>
          <ul id="tipsList" class="sub"></ul>
        </div>

        <div class="card" style="margin-top:12px">
          <strong>Check a code against your result</strong>
          <div class="muted">Paste their 5‑digit code. We’ll show both scores and your fit.</div>
          <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap;">
            <input id="codeInputCheck" type="number" placeholder="e.g., 48231" style="max-width:180px" />
            <button class="btn2" id="checkBtn">Check</button>
          </div>
          <div id="checkOut" class="muted" style="margin-top:8px"></div>
        </div>

      </div>

      <footer>
        Built for client-only use. No data leaves your device.
        &nbsp;•&nbsp;<a href="#" id="scienceLink">See the Science behind this</a>
      </footer>
    </div>

    <script>
      // ---------- Embedded City Pack (~40), alphabetized by state then city ----------
      const METROS = [
        { id:"NATIONAL", name:"National baseline", ratio:100, marriedPct:51.0 },
        // AK
        { id:"ANC", name:"Anchorage, AK", ratio:123.5, marriedPct:48.2 },
        // AL
        { id:"MOB", name:"Mobile, AL", ratio:86.8, marriedPct:33.8 },
        // AZ
        { id:"GLD", name:"Glendale, AZ", ratio:90.4, marriedPct:48.0 },
        // CA
        { id:"CHV", name:"Chula Vista, CA", ratio:127.5, marriedPct:50.5 },
        { id:"IRV", name:"Irvine, CA", ratio:98.5, marriedPct:49.7 },
        { id:"OCE", name:"Oceanside, CA", ratio:152.7, marriedPct:47.3 },
        { id:"SJC", name:"San Jose, CA", ratio:123.9, marriedPct:48.1 },
        // CO
        { id:"COS", name:"Colorado Springs, CO", ratio:121.0, marriedPct:52.9 },
        { id:"PUB", name:"Pueblo, CO", ratio:125.8, marriedPct:40.6 },
        // DC
        { id:"DC",  name:"Washington, DC", ratio:86.4, marriedPct:32.4 },
        // FL
        { id:"STP", name:"St. Petersburg, FL", ratio:93.3, marriedPct:42.1 },
        // GA
        { id:"ATL", name:"Atlanta, GA", ratio:92.7, marriedPct:30.0 },
        { id:"AGS", name:"Augusta, GA", ratio:107.8, marriedPct:31.9 },
        { id:"CLB", name:"Columbus, GA", ratio:100.5, marriedPct:38.0 },
        // LA
        { id:"NO",  name:"New Orleans, LA", ratio:85.3, marriedPct:33.6 },
        // MA
        { id:"BOS", name:"Boston, MA", ratio:90.7, marriedPct:29.7 },
        // MD
        { id:"BAL", name:"Baltimore, MD", ratio:86.4, marriedPct:27.6 },
        // MI
        { id:"DET", name:"Detroit, MI", ratio:92.7, marriedPct:22.9 },
        // NC
        { id:"FAY", name:"Fayetteville, NC", ratio:141.5, marriedPct:42.0 },
        { id:"GSO", name:"Greensboro, NC", ratio:87.4, marriedPct:35.1 },
        // NJ
        { id:"NWK", name:"Newark, NJ", ratio:106.2, marriedPct:26.0 },
        // NM
        { id:"ABQ", name:"Albuquerque, NM", ratio:111.8, marriedPct:38.8 },
        // NV
        { id:"HND", name:"Henderson, NV", ratio:102.9, marriedPct:49.8 },
        { id:"PAR", name:"Paradise, NV", ratio:137.1, marriedPct:35.2 },
        { id:"SPV", name:"Spring Valley, NV", ratio:131.4, marriedPct:43.2 },
        // NY
        { id:"ROC", name:"Rochester, NY", ratio:102.4, marriedPct:22.4 },
        // OH
        { id:"CIN", name:"Cincinnati, OH", ratio:96.4, marriedPct:29.6 },
        { id:"CLE", name:"Cleveland, OH", ratio:94.5, marriedPct:22.7 },
        { id:"TOL", name:"Toledo, OH", ratio:102.8, marriedPct:33.4 },
        // PA
        { id:"PHL", name:"Philadelphia, PA", ratio:91.2, marriedPct:33.6 },
        { id:"PIT", name:"Pittsburgh, PA", ratio:92.0, marriedPct:32.3 },
        // TN
        { id:"MEM", name:"Memphis, TN", ratio:91.3, marriedPct:30.1 },
        // TX
        { id:"AUS", name:"Austin, TX", ratio:122.3, marriedPct:40.9 },
        { id:"GAR", name:"Garland, TX", ratio:125.2, marriedPct:50.1 },
        { id:"PLN", name:"Plano, TX", ratio:107.3, marriedPct:55.9 },
        // VA
        { id:"CHK", name:"Chesapeake, VA", ratio:106.5, marriedPct:52.7 },
        { id:"VAB", name:"Virginia Beach, VA", ratio:108.7, marriedPct:49.7 },
        // WA
        { id:"SPK", name:"Spokane, WA", ratio:119.8, marriedPct:42.3 },
        { id:"VAN", name:"Vancouver, WA", ratio:106.7, marriedPct:43.7 },
        // WI
        { id:"MKE", name:"Milwaukee, WI", ratio:96.8, marriedPct:30.4 }
      ];

      // ---------- Config ----------
      const SCALE_MAX = 5; // using a 5-point response scale
      const LIKERT = [
        { value: 1, label: "Strongly disagree" },
        { value: 2, label: "Disagree" },
        { value: 3, label: "Neither agree nor disagree" },
        { value: 4, label: "Agree" },
        { value: 5, label: "Strongly agree" },
      ];

      const SCORING_WEIGHTS = {
        intrinsic: +1.0,
        identified: +1.0,
        positiveIntrojected: +0.5,
        negativeIntrojected: -0.5,
        external: -1.0,
        amotivation: -1.0,
      };

      const BANDS = [
        { key: "ready", labelLine1: "Ready for relationship", labelLine2: "High overall readiness", min: 70, max: 100 },
        { key: "unsure", labelLine1: "Unsure but open to relationship", labelLine2: "Moderate overall readiness", min: 40, max: 69 },
        { key: "notready", labelLine1: "Not ready", labelLine2: "Low overall readiness", min: 0, max: 39 },
      ];

      const PAIR_THRESHOLDS_5PT = { intrinsicMin: 4.0, identifiedMin: 4.0, negIntroMax: 2.5 };
      const PARTNER_SCORE_SHORTCUT = 70;

      const SUBSCALE_LABELS = {
        intrinsic: "Intrinsic",
        identified: "Identified",
        positiveIntrojected: "Positive Introjected",
        negativeIntrojected: "Negative Introjected",
        external: "External",
        amotivation: "Amotivation",
      };

      const ITEMS = [
        { id:"i1", subscale:"intrinsic", text:"Because being in a relationship feels good to me." },
        { id:"i2", subscale:"intrinsic", text:"Because I enjoy sharing life with a partner." },
        { id:"i3", subscale:"intrinsic", text:"Because close connection is uplifting to me." },
        { id:"i4", subscale:"intrinsic", text:"Because a relationship would be fun and fulfilling." },
        { id:"id1", subscale:"identified", text:"Because being in a relationship fits my values." },
        { id:"id2", subscale:"identified", text:"Because it aligns with who I want to be." },
        { id:"id3", subscale:"identified", text:"Because building a relationship matters to me." },
        { id:"id4", subscale:"identified", text:"Because commitment is an important life goal for me." },
        { id:"pi1", subscale:"positiveIntrojected", text:"Because I would feel proud to be in a relationship." },
        { id:"pi2", subscale:"positiveIntrojected", text:"Because it would boost my confidence." },
        { id:"pi3", subscale:"positiveIntrojected", text:"Because it would help me feel capable and strong." },
        { id:"pi4", subscale:"positiveIntrojected", text:"Because it would make me feel good about myself." },
        { id:"ni1", subscale:"negativeIntrojected", text:"Because being single makes me feel not good enough." },
        { id:"ni2", subscale:"negativeIntrojected", text:"Because I feel bad about myself when I’m not partnered." },
        { id:"ni3", subscale:"negativeIntrojected", text:"Because I’d feel guilty about staying single." },
        { id:"ni4", subscale:"negativeIntrojected", text:"Because I’d feel like a loser if I weren’t in a relationship." },
        { id:"e1", subscale:"external", text:"Because people close to me expect me to be partnered." },
        { id:"e2", subscale:"external", text:"Because it would make family or friends happy." },
        { id:"e3", subscale:"external", text:"Because society says I should be in a relationship." },
        { id:"e4", subscale:"external", text:"Because I want to avoid others’ judgment about being single." },
        { id:"a1", subscale:"amotivation", text:"There is no real reason I want to be in a relationship." },
        { id:"a2", subscale:"amotivation", text:"I don’t know why I want a relationship." },
        { id:"a3", subscale:"amotivation", text:"I feel indifferent about pursuing a relationship." },
        { id:"a4", subscale:"amotivation", text:"I’m not pursuing a relationship for any particular reason." },
      ];

      // ---------- State ----------
      const answers = {};
      const totalItems = ITEMS.length;

      // ---------- DOM refs ----------
      const questionBlocks = document.getElementById("questionBlocks");
      const answeredCountEl = document.getElementById("answeredCount");
      const totalItemsEl = document.getElementById("totalItems");
      const progressBar = document.getElementById("progressBar");
      const resultsCard = document.getElementById("resultsCard");
      const subscaleMeters = document.getElementById("subscaleMeters");
      const readinessScoreEl = document.getElementById("readinessScore");
      const readinessBandEl = document.getElementById("readinessBand");
      const readinessLabelEl = document.getElementById("readinessLabel");
      const statusPill = document.getElementById("statusPill");
      const breakdown = document.getElementById("breakdown");
      const lblReady = document.getElementById("lbl-ready");
      const lblUnsure = document.getElementById("lbl-unsure");
      const lblNotReady = document.getElementById("lbl-notready");
      const probabilityLine = document.getElementById("probabilityLine");
      const pairNote = document.getElementById("pairNote");
      const citySel = document.getElementById("city");
      const poolSel = document.getElementById("pool");
      const ageInput = document.getElementById("age");
      const ageWarn = document.getElementById("ageWarn");
      const monthsInput = document.getElementById("monthsSince");
      const initiatorChk = document.getElementById("initiator");
      const badgeCodeEl = document.getElementById("badgeCode");
      const badgeExplain = document.getElementById("badgeExplain");
      const copyBtn = document.getElementById("copyCode");
      const codeInputCheck = document.getElementById("codeInputCheck");
      const checkBtn = document.getElementById("checkBtn");
      const checkOut = document.getElementById("checkOut");
      const badgeVariantSel = document.getElementById("badgeVariant");
      const dlStory = document.getElementById("dlStory");
      const dlSquare = document.getElementById("dlSquare");
      const dlWide = document.getElementById("dlWide");
      const badgeCanvas = document.getElementById("badgeCanvas");
      const badgePreviewCanvas = document.getElementById("badgePreviewCanvas");
      const prevCtx = badgePreviewCanvas.getContext("2d");

      totalItemsEl.textContent = totalItems.toString();

      (function fillCityList(){
        METROS.forEach(m => {
          const opt = document.createElement("option");
          opt.value = m.id;
          opt.textContent = m.name;
          citySel.appendChild(opt);
        });
      })();

      function setBandLabels() {
        const ready = BANDS.find(b => b.key === "ready");
        const theUnsure = BANDS.find(b => b.key === "unsure");
        const notr = BANDS.find(b => b.key === "notready");
        if (ready) lblReady.textContent = `${ready.labelLine1}: ${ready.min}–${ready.max}`;
        if (theUnsure) lblUnsure.textContent = `${theUnsure.labelLine1}: ${theUnsure.min}–${theUnsure.max}`;
        if (notr) lblNotReady.textContent = `${notr.labelLine1}: ${notr.min}–${notr.max}`;
      }

      function normalizeTo100(x, min, max) {
        const clamped = Math.max(min, Math.min(max, x));
        const pct = (clamped - min) / (max - min);
        return Math.round(pct * 100);
      }

      function weightedRange(weights) {
        const w = Object.values(weights);
        const min = w.reduce((s, wi) => (wi >= 0 ? s + wi * 1 : s + wi * SCALE_MAX), 0);
        const max = w.reduce((s, wi) => (wi >= 0 ? s + wi * SCALE_MAX : s + wi * 1), 0);
        return { min, max };
      }

      function computeSubscaleAverages() {
        const sums = {};
        for (const key of Object.keys(SCORING_WEIGHTS)) sums[key] = { sum:0, n:0 };
        for (const item of ITEMS) {
          const v = answers[item.id];
          if (typeof v === "number") {
            sums[item.subscale].sum += v;
            sums[item.subscale].n += 1;
          }
        }
        const avgs = {};
        for (const k of Object.keys(sums)) {
          const { sum, n } = sums[k];
          avgs[k] = n > 0 ? sum / n : 0;
        }
        return avgs;
      }

      function computeReadiness(subscaleAverages) {
        let raw = 0;
        for (const [k, w] of Object.entries(SCORING_WEIGHTS)) {
          raw += (subscaleAverages[k] || 0) * w;
        }
        const { min, max } = weightedRange(SCORING_WEIGHTS);
        const score100 = normalizeTo100(raw, min, max);
        let bandObj = BANDS.find(b => score100 >= b.min && score100 <= b.max);
        if (!bandObj) bandObj = { labelLine1: "—", labelLine2: "—", min:0, max:100, key:"?" };
        return { score100, bandObj };
      }

      const PROB_BASE_RATE_NAT = 0.30;
      const OR = { intrinsic: 1.47, identified: 1.35, negIntro: 0.85 };
      const REF_MEAN_5PT = { intrinsic: 3.6, identified: 3.3, negIntro: 1.9 };
      const INITIATOR_BUMP_LOGIT = 0.2;

      function computeSinglePersonProbability(subscaleAverages5, p0_adj, logitBump) {
        const i5 = subscaleAverages5.intrinsic || 0;
        const id5 = subscaleAverages5.identified || 0;
        const ni5 = subscaleAverages5.negativeIntrojected || 0;
        const logit0 = Math.log(p0_adj / (1 - p0_adj)) + (logitBump || 0);
        const contrib =
          Math.log(OR.intrinsic) * (i5 - REF_MEAN_5PT.intrinsic) +
          Math.log(OR.identified) * (id5 - REF_MEAN_5PT.identified) +
          Math.log(OR.negIntro) * (ni5 - REF_MEAN_5PT.negIntro);
        const logit = logit0 + contrib;
        const p = 1 / (1 + Math.exp(-logit));
        return { p, i5, id5, ni5 };
      }

      const UNMARRIED_SHARE_NAT = 0.49;
      const ALPHA = 0.8;
      const BETA = 0.25;
      const MULT_MIN = 0.7, MULT_MAX = 1.4;

      function computeGeoBaseRate() {
        const metro = METROS.find(m => m.id === citySel.value) || METROS[0];
        const shareGeo = Math.max(0.05, Math.min(0.95, 1 - (metro.marriedPct/100)));
        let mult = Math.pow(shareGeo / UNMARRIED_SHARE_NAT, ALPHA);
        const r = metro.ratio;
        let srFactor = 1.0;
        if (poolSel.value === "womanSeekingMan") {
          srFactor = r / 100;
        } else if (poolSel.value === "manSeekingWoman") {
          srFactor = 100 / r;
        }
        mult *= Math.pow(srFactor, BETA);
        mult = Math.max(MULT_MIN, Math.min(MULT_MAX, mult));
        return Math.max(0.05, Math.min(0.8, PROB_BASE_RATE_NAT * mult));
      }

      function durationFactorFromMonths(m) {
        if (!isFinite(m) || m === null || m === undefined || isNaN(m)) return 1.0;
        if (m <= 12) return 1.0;
        const years = m / 12;
        return Math.exp(-0.07 * (years - 1));
      }

      function computeDurationAdjustedBaseRate(p0_geo) {
        const m = parseInt(monthsInput.value, 10);
        const f = durationFactorFromMonths(m);
        const p = p0_geo * f;
        return Math.max(0.05, Math.min(0.8, p));
      }

      function computeInitiatorBump() {
        const m = parseInt(monthsInput.value, 10);
        if (initiatorChk.checked && isFinite(m) && !isNaN(m) && m <= 12) {
          return INITIATOR_BUMP_LOGIT;
        }
        return 0.0;
      }

      function meetsPairThresholds(i5, id5, ni5) {
        return (i5 >= PAIR_THRESHOLDS_5PT.intrinsicMin) &&
               (id5 >= PAIR_THRESHOLDS_5PT.identifiedMin) &&
               (ni5 <= PAIR_THRESHOLDS_5PT.negIntroMax);
      }

      function updateProgress() {
        const answeredCount = Object.keys(answers).length;
        answeredCountEl.textContent = answeredCount.toString();
        const pct = Math.round((answeredCount / totalItems) * 100);
        progressBar.style.width = pct + "%";
        statusPill.textContent = answeredCount === totalItems ? "Complete" : "Incomplete";
      }

      function renderQuestions() {
        const shuffled = ITEMS.slice().sort(() => Math.random() - 0.5);
        const frag = document.createDocumentFragment();
        shuffled.forEach(it => {
          const row = document.createElement("div"); row.className = "row";
          const q = document.createElement("div"); q.className = "q"; q.textContent = it.text; row.appendChild(q);
          const grid = document.createElement("div"); grid.className = "grid";
          LIKERT.forEach(opt => {
            const b = document.createElement("button");
            b.className = "btn"; b.textContent = String(opt.value); b.title = opt.label;
            b.addEventListener("click", () => {
              answers[it.id] = opt.value;
              Array.from(grid.children).forEach(ch => ch.classList.remove("sel"));
              b.classList.add("sel");
              updateProgress();
              renderResults();
            });
            grid.appendChild(b);
          });
          row.appendChild(grid);
          const selected = document.createElement("div");
          selected.className = "sub"; selected.id = "sel-" + it.id; selected.textContent = "Selected: None";
          row.appendChild(selected);
          row.addEventListener("click", () => {
            const v = answers[it.id];
            const found = LIKERT.find(l => l.value === v);
            selected.textContent = "Selected: " + (found ? (v + " – " + found.label) : "None");
          });
          frag.appendChild(row);
        });
        questionBlocks.appendChild(frag);
      }

      function renderBreakdown(avgs) {
        subscaleMeters.innerHTML = "";
        Object.keys(SCORING_WEIGHTS).forEach(k => {
          const wrap = document.createElement("div");
          const top = document.createElement("div");
          top.className = "flex";
          top.innerHTML = "<span>" + SUBSCALE_LABELS[k] + "</span><span>" + (avgs[k] || 0).toFixed(2) + " / " + SCALE_MAX + "</span>";
          const meter = document.createElement("div");
          meter.className = "meter";
          const fill = document.createElement("div");
          fill.style.width = (((avgs[k] || 0) / SCALE_MAX) * 100) + "%";
          meter.appendChild(fill);
          wrap.appendChild(top);
          wrap.appendChild(meter);
          subscaleMeters.appendChild(wrap);
        });
      }

      function ageValid() {
        const age = parseInt(ageInput.value, 10);
        const ok = !isNaN(age) && age >= 18 && age <= 39;
        ageWarn.classList.toggle("hidden", ok);
        return ok;
      }

      // ---- Badge Code ----
      const ORDER = ["external","positiveIntrojected","intrinsic","amotivation","identified","negativeIntrojected"];
      const A = 42193, B = 37489, M = 100000, INV = 15057;

      function makeBadgeCode(avgs) {
        const levels = ORDER.map(k => Math.max(1, Math.min(5, Math.round(avgs[k] || 0))));
        let idx = 0, base = 1;
        for (let i=0;i<ORDER.length;i++) { idx += (levels[i]-1)*base; base *= 5; }
        const code = (A*idx + B) % M;
        return { codeStr: String(code).padStart(5,"0"), levels };
      }

      function renderBadge(avgs) {
        const { codeStr } = makeBadgeCode(avgs);
        badgeCodeEl.textContent = codeStr;
        badgeExplain.textContent = "Copy this into your profile. Others can check fit here with your code.";
      }

      function copyBadge() {
        const s = badgeCodeEl.textContent;
        navigator.clipboard.writeText(s).then(() => {
          const old = copyBtn.textContent;
          copyBtn.textContent = "Copied";
          setTimeout(()=>copyBtn.textContent=old, 1200);
        });
      }

      // ----- Tips -----
      function generateTips(avgs) {
        const tips = [];
        const scoreInfo = computeReadiness(avgs);
        if (scoreInfo.score100 >= 70) {
          tips.push("Keep doing what works: keep values‑aligned dating and honest check‑ins.");
          tips.push("Protect time for fun, not just outcomes — joy fuels good relationships.");
        } else if (scoreInfo.score100 >= 40) {
          tips.push("Pick one weekly action that matches your values (text first, set a boundary, plan a real date).");
          tips.push("Reduce 'shoulds': swap one self‑critique with a concrete next step.");
        } else {
          tips.push("Start small: 10‑minute walk + one message to a friend today to rebuild momentum.");
          tips.push("List 3 partner qualities you want and 3 strengths you bring — then act on one this week.");
        }
        return tips;
      }

      // -------- Badge preview drawing (uses same visual language) --------
      function gradientBackground(ctx, w, h) {
        const g = ctx.createLinearGradient(0, 0, w, h);
        g.addColorStop(0, getComputedStyle(document.documentElement).getPropertyValue('--bg1').trim());
        g.addColorStop(1, getComputedStyle(document.documentElement).getPropertyValue('--bg2').trim());
        ctx.fillStyle = g;
        ctx.fillRect(0,0,w,h);
      }

      function drawIcon(ctx, variant, w, h) {
        ctx.save();
        ctx.translate(w/2, h*0.38);
        ctx.scale(Math.min(w,h)/1000, Math.min(w,h)/1000);
        ctx.lineJoin = "round";
        let stroke = "#06D6A0";
        if (variant==="all_low") stroke = "#e07a1f";
        if (variant==="all_medium") stroke = "#5b43ff";
        if (variant==="all_high") stroke = "#06D6A0";
        if (variant==="one_area") stroke = "#06D6A0";
        ctx.strokeStyle = stroke;
        ctx.lineWidth = 32;
        ctx.fillStyle = "rgba(255,255,255,0.85)";
        // Star for all_high by default
        ctx.beginPath();
        for (let i=0;i<10;i++) {
          const angle = i * Math.PI/5;
          const r = i%2===0 ? 320 : 150;
          ctx.lineTo(Math.cos(angle)*r, Math.sin(angle)*r);
        }
        ctx.closePath();
        ctx.fill();
        ctx.stroke();
        ctx.restore();
      }

      function drawBadgePreview(avgs, score100, bandText) {
        const ctx = prevCtx;
        const w = badgePreviewCanvas.width, h = badgePreviewCanvas.height;
        gradientBackground(ctx, w, h);
        ctx.fillStyle = "#333333";
        ctx.textAlign = "center";
        ctx.font = Math.floor(h*0.06) + "px Inter, sans-serif";
        ctx.fillText("Ready to Relate", w/2, h*0.12);
        drawIcon(ctx, "all_high", w, h);
        ctx.font = Math.floor(h*0.08) + "px Inter, sans-serif";
        ctx.fillText("Score: " + (score100==null?"—":score100), w/2, h*0.6);
        ctx.font = Math.floor(h*0.04) + "px Inter, sans-serif";
        ctx.fillText(bandText || "—", w/2, h*0.66);
        ctx.font = Math.floor(h*0.025) + "px Inter, sans-serif";
        ctx.fillText("readytorelate.com", w/2, h*0.92);
      }

      function updateDownloadsEnabled(enable) {
        dlStory.disabled = !enable;
        dlSquare.disabled = !enable;
        dlWide.disabled = !enable;
      }

      function renderResults() {
        const avgs = computeSubscaleAverages();
        const { score100, bandObj } = computeReadiness(avgs);

        readinessScoreEl.textContent = (Object.keys(answers).length>0) ? String(score100) : "—";
        readinessLabelEl.textContent = (Object.keys(answers).length>0 && bandObj) ? bandObj.labelLine1 : "Start answering to see your score";
        readinessBandEl.textContent = (Object.keys(answers).length>0 && bandObj) ? bandObj.labelLine2 : "—";

        // Probability text (only after valid age)
        if (ageValid() && Object.keys(answers).length>0) {
          const p0_geo = computeGeoBaseRate();
          const p0_adj = computeDurationAdjustedBaseRate(p0_geo);
          const bump = computeInitiatorBump();
          const { p } = computeSinglePersonProbability(avgs, p0_adj, bump);
          const pct = Math.round(p * 100);
          const m = parseInt(monthsInput.value, 10);
          const durTxt = (!isFinite(m) || isNaN(m)) ? "no duration entered" : (m + " months since last relationship");
          probabilityLine.textContent =
            `With your score of ${score100}, we estimate a ≈ ${pct}% chance of being in a relationship in ~6 months (adjusted for your city, dating pool, and ${durTxt}${bump>0?" — early initiator bump applied":""}).`;
        } else {
          probabilityLine.textContent = "Enter your age to unlock the estimate.";
        }

        // Breakdown & badge code
        renderBreakdown(avgs);
        renderBadge(avgs);

        // Tips
        const tips = (Object.keys(answers).length>0) ? generateTips(avgs) : [];
        document.getElementById("tipsList").innerHTML = tips.map(t=>`<li>${t}</li>`).join("");

        // Draw & blur logic for preview
        drawBadgePreview(avgs, (Object.keys(answers).length>0)?score100:null, bandObj ? bandObj.labelLine1 : null);
        const complete = (Object.keys(answers).length === totalItems) && ageValid();
        badgePreviewCanvas.classList.toggle("blurred", !complete);
        updateDownloadsEnabled(complete);
      }

      function maybeShowResults(){ renderResults(); }

      // Downloads (unchanged behavior)
      function downloadCanvasPng(filename) {
        const url = badgeCanvas.toDataURL("image/png");
        const a = document.createElement("a");
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        a.remove();
      }

      function pickVariant(avgs, score100, bandKey) {
        const entries = Object.entries(avgs);
        let top = entries[0];
        for (const e of entries) if ((e[1]||0) > (top[1]||0)) top = e;
        const hasStrongOne = (top && (top[1]||0) >= 4.5);
        if (badgeVariantSel.value === "one_area") return { key:"one_area", area: top ? top[0] : null };
        if (badgeVariantSel.value === "all_high") return { key:"all_high" };
        if (badgeVariantSel.value === "all_medium") return { key:"all_medium" };
        if (badgeVariantSel.value === "all_low") return { key:"all_low" };
        if (score100 >= 70 && meetsPairThresholds(avgs.intrinsic||0, avgs.identified||0, avgs.negativeIntrojected||0)) return { key:"all_high" };
        else if (hasStrongOne) return { key:"one_area", area: top ? top[0] : null };
        else if (score100 >= 40) return { key:"all_medium" };
        else return { key:"all_low" };
      }

      function drawIconFull(ctx, variant, w, h) {
        ctx.save();
        ctx.translate(w/2, h*0.38);
        ctx.scale(Math.min(w,h)/1000, Math.min(w,h)/1000);
        ctx.lineJoin = "round";
        let stroke = "#06D6A0";
        if (variant==="all_low") stroke = "#e07a1f";
        if (variant==="all_medium") stroke = "#5b43ff";
        if (variant==="all_high") stroke = "#06D6A0";
        if (variant==="one_area") stroke = "#06D6A0";
        ctx.strokeStyle = stroke;
        ctx.lineWidth = 32;
        ctx.fillStyle = "rgba(255,255,255,0.85)";
        if (variant==="all_high") {
          ctx.beginPath();
          for (let i=0;i<10;i++){ const a=i*Math.PI/5; const r=i%2===0?320:150; ctx.lineTo(Math.cos(a)*r, Math.sin(a)*r); }
          ctx.closePath(); ctx.fill(); ctx.stroke();
        } else if (variant==="all_medium") {
          ctx.beginPath(); ctx.arc(0,0,300,0,Math.PI*2); ctx.fill(); ctx.stroke();
          ctx.beginPath(); ctx.moveTo(-140,0); ctx.lineTo(-20,120); ctx.lineTo(160,-100); ctx.stroke();
        } else if (variant==="all_low") {
          ctx.beginPath(); ctx.moveTo(0,-320); ctx.lineTo(300,240); ctx.lineTo(-300,240); ctx.closePath(); ctx.fill(); ctx.stroke();
          ctx.beginPath(); ctx.moveTo(0,-200); ctx.lineTo(0,80); ctx.stroke();
          ctx.beginPath(); ctx.arc(0,160,20,0,Math.PI*2); ctx.fillStyle=stroke; ctx.fill();
        } else {
          ctx.beginPath(); ctx.arc(0,0,280,0,Math.PI*2); ctx.fill(); ctx.stroke();
          ctx.beginPath(); ctx.moveTo(-120,220); ctx.lineTo(-40,380); ctx.lineTo(0,280); ctx.closePath(); ctx.fillStyle="rgba(255,255,255,0.9)"; ctx.fill(); ctx.stroke();
          ctx.beginPath(); ctx.moveTo(120,220); ctx.lineTo(40,380); ctx.lineTo(0,280); ctx.closePath(); ctx.fill(); ctx.stroke();
        }
        ctx.restore();
      }

      function gradientBackgroundFull(ctx, w, h) {
        const g = ctx.createLinearGradient(0, 0, w, h);
        g.addColorStop(0, getComputedStyle(document.documentElement).getPropertyValue('--bg1').trim());
        g.addColorStop(1, getComputedStyle(document.documentElement).getPropertyValue('--bg2').trim());
        ctx.fillStyle = g; ctx.fillRect(0,0,w,h);
      }

      function drawBadgeToCanvas({w, h, score, code, band, variantKey, area}) {
        const ctx = badgeCanvas.getContext("2d");
        badgeCanvas.width = w;
        badgeCanvas.height = h;
        gradientBackgroundFull(ctx, w, h);
        ctx.fillStyle="#333333"; ctx.textAlign="center";
        ctx.font = Math.floor(h*0.06) + "px Inter, sans-serif";
        ctx.fillText("Ready to Relate", w/2, h*0.12);
        drawIconFull(ctx, variantKey, w, h);
        ctx.font = Math.floor(h*0.08) + "px Inter, sans-serif"; ctx.fillText("Score: " + score, w/2, h*0.6);
        ctx.font = Math.floor(h*0.04) + "px Inter, sans-serif"; ctx.fillText(band, w/2, h*0.66);
        let vLabel = ""; if (variantKey==="all_high") vLabel="All-around High"; else if (variantKey==="all_medium") vLabel="All-around Medium";
        else if (variantKey==="all_low") vLabel="All-around Low"; else if (variantKey==="one_area") vLabel="High in " + (SUBSCALE_LABELS[area]||"Top Area");
        ctx.font = Math.floor(h*0.035) + "px Inter, sans-serif"; ctx.fillText(vLabel, w/2, h*0.73);
        const chip = code; const chipW = ctx.measureText(chip).width + 48; const chipH = Math.floor(h*0.05) + 18;
        const chipX = (w - chipW)/2; const chipY = h*0.78 - chipH/2;
        ctx.fillStyle="rgba(255,255,255,0.9)"; ctx.strokeStyle="#06D6A0"; ctx.lineWidth = 3;
        const r = 14;
        ctx.beginPath();
        ctx.moveTo(chipX+r, chipY); ctx.lineTo(chipX+chipW-r, chipY);
        ctx.quadraticCurveTo(chipX+chipW, chipY, chipX+chipW, chipY+r);
        ctx.lineTo(chipX+chipW, chipY+chipH-r);
        ctx.quadraticCurveTo(chipX+chipW, chipY+chipH, chipX+chipW-r, chipY+chipH);
        ctx.lineTo(chipX+r, chipY+chipH);
        ctx.quadraticCurveTo(chipX, chipY+chipH, chipX, chipY+chipH-r);
        ctx.lineTo(chipX, chipY+r);
        ctx.quadraticCurveTo(chipX, chipY, chipX+r, chipY);
        ctx.closePath(); ctx.fill(); ctx.stroke();
        ctx.fillStyle="#333333"; ctx.font = Math.floor(h*0.04) + "px Inter, sans-serif"; ctx.fillText(chip, w/2, h*0.80 + chipH/3);
        ctx.font = Math.floor(h*0.025) + "px Inter, sans-serif"; ctx.fillText("readytorelate.com", w/2, h*0.92);
      }

      function doDownload(target) {
        const avgs = computeSubscaleAverages();
        const { score100, bandObj } = computeReadiness(avgs);
        const selection = pickVariant(avgs, score100, bandObj.key);
        const { codeStr } = makeBadgeCode(avgs);
        const bandText = bandObj.labelLine1;
        let dims = { w:1080, h:1080, tag: "square" };
        if (target==="story") dims = { w:1080, h:1920, tag: "story" };
        if (target==="wide") dims = { w:1600, h:900, tag: "wide" };
        drawBadgeToCanvas({ w:dims.w, h:dims.h, score:score100, code:codeStr, band:bandText, variantKey:selection.key, area:selection.area });
        const url = badgeCanvas.toDataURL("image/png");
        const a = document.createElement("a"); a.href = url; a.download = `rfr_badge_${selection.key}_${dims.tag}.png`; document.body.appendChild(a); a.click(); a.remove();
      }

      dlStory.addEventListener("click", ()=> doDownload("story"));
      dlSquare.addEventListener("click", ()=> doDownload("square"));
      dlWide.addEventListener("click", ()=> doDownload("wide"));

      document.getElementById("toTop")?.addEventListener("click", () => window.scrollTo({ top: 0, behavior: "smooth" }));
      document.getElementById("resetBtn")?.addEventListener("click", () => {
        for (const k of Object.keys(answers)) delete answers[k];
        document.querySelectorAll(".btn.sel").forEach(el => el.classList.remove("sel"));
        ITEMS.forEach(it => {
          const sel = document.getElementById("sel-" + it.id);
          if (sel) sel.textContent = "Selected: None";
        });
        updateProgress();
        renderResults();
        window.scrollTo({ top: 0, behavior: "smooth" });
      });
      citySel.addEventListener("change", renderResults);
      poolSel.addEventListener("change", renderResults);
      ageInput.addEventListener("input", renderResults);
      monthsInput.addEventListener("input", renderResults);
      initiatorChk.addEventListener("change", renderResults);
      copyBtn.addEventListener("click", copyBadge);
      checkBtn.addEventListener("click", renderResults);

      // Init
      (function renderShuffled() {
        const shuffled = ITEMS.slice().sort(() => Math.random() - 0.5);
        const frag = document.createDocumentFragment();
        shuffled.forEach(it => {
          const row = document.createElement("div");
          row.className = "row";
          const q = document.createElement("div");
          q.className = "q";
          q.textContent = it.text;
          row.appendChild(q);
          const grid = document.createElement("div");
          grid.className = "grid";
          LIKERT.forEach(opt => {
            const b = document.createElement("button");
            b.className = "btn";
            b.textContent = String(opt.value);
            b.title = opt.label;
            b.addEventListener("click", () => {
              answers[it.id] = opt.value;
              Array.from(grid.children).forEach(ch => ch.classList.remove("sel"));
              b.classList.add("sel");
              updateProgress();
              renderResults();
            });
            grid.appendChild(b);
          });
          row.appendChild(grid);
          const selected = document.createElement("div");
          selected.className = "sub";
          selected.id = "sel-" + it.id;
          selected.textContent = "Selected: None";
          row.appendChild(selected);
          row.addEventListener("click", () => {
            const v = answers[it.id];
            const found = LIKERT.find(l => l.value === v);
            selected.textContent = "Selected: " + (found ? (v + " – " + found.label) : "None");
          });
          frag.appendChild(row);
        });
        questionBlocks.appendChild(frag);
      })();
      updateProgress();
      setBandLabels();
      renderResults();
    </script>
  </body>
</html>
