<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Ready to Relate</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --fg:#333333; --bg1:#E7D6F7; --bg2:#CBB2FF; --card:#FFD166; --accent:#06D6A0;
      --accent-soft:#BFF3E8; --border:#d9b458; --link:#5b43ff;
    }
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,Arial;color:var(--fg);
      background:linear-gradient(135deg,var(--bg1),var(--bg2));background-attachment:fixed;}
    a{color:var(--link)}
    .wrap{max-width:960px;margin:0 auto;padding:28px 24px 40px}
    h1{font-size:40px;font-weight:800;letter-spacing:-.02em;margin:0 0 6px}
    .lead{margin:0 0 18px;font-weight:600}
    .card{background:var(--card);border:1px solid var(--border);border-radius:18px;padding:18px;box-shadow:0 4px 20px rgba(0,0,0,.08);margin:12px 0}
    .grid2{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    label{font-size:12px;font-weight:600;margin-bottom:6px;display:block}
    input[type="number"],input[type="email"],select{width:100%;border:1px solid #cbb37a;border-radius:10px;padding:10px;background:#fff}
    .progress{height:16px;background:var(--accent-soft);border-radius:999px;overflow:hidden;box-shadow:inset 0 0 0 1px #8de3d4}
    .progress>div{height:100%;background:var(--accent);transition:width .2s ease}
    .row{padding:12px 0;border-bottom:1px solid rgba(0,0,0,.08)}
    .row:last-child{border-bottom:0}
    .q{font-weight:600;margin-bottom:8px}
    .grid5{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:8px}
    .btn{border:1px solid #07c59a;background:#fff;border-radius:12px;padding:10px 0;cursor:pointer;font-weight:600}
    .btn.sel{background:var(--accent);color:#fff;border-color:var(--accent)}
    .btn2{border:1px solid #07c59a;background:#fff;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:600}
    .btn2.primary{background:var(--accent);color:#fff}
    .btn2:disabled{opacity:.5;cursor:not-allowed}
    .flex{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .sub{font-size:12px}
    .pill{display:inline-block;font-size:12px;padding:4px 10px;border-radius:999px;border:1px solid #07c59a;background:#fff}
    .meter{height:8px;background:#f6e3a6;border-radius:999px;overflow:hidden}
    .meter>div{height:100%;background:#7c5cff}
    .code{font-family:ui-monospace,Consolas,monospace;font-size:18px;padding:6px 10px;border:1px dashed #cbb37a;border-radius:10px;background:#fff6cf}
    .dl-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;align-items:center}
    .previewWrap{position:relative;margin-top:10px}
    #badgePreview{display:block;width:100%;height:auto;border-radius:16px;border:1px solid var(--border)}
    .blur{filter: blur(6px) grayscale(.15)}
    .ok{color:#16a34a}.err{color:#b91c1c}.muted{font-size:12px;opacity:.9}
    footer{font-size:12px;margin-top:18px;opacity:.9}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Ready to Relate</h1>
    <p class="lead">Answer the 24 questions. Get a score. See a shareable 5-digit code. Everything runs in your browser.</p>

    <!-- Setup -->
    <div class="card">
      <div class="grid2">
        <div>
          <label for="age">Your age (18–39) *</label>
          <input id="age" type="number" min="18" max="39" placeholder="e.g., 28" />
          <div id="ageWarn" class="sub err" style="display:none">Enter a valid age 18–39.</div>
        </div>
        <div>
          <label for="city">City</label>
          <select id="city"><option value="NATIONAL">Use national baseline</option></select>
        </div>
        <div>
          <label for="pool">Dating pool</label>
          <select id="pool">
            <option value="womanSeekingMan">Woman seeking men</option>
            <option value="manSeekingWoman">Man seeking women</option>
          </select>
        </div>
      </div>
      <div style="margin-top:8px">
        <label for="months">Months since last serious relationship (optional)</label>
        <input id="months" type="number" min="0" max="240" placeholder="e.g., 6" />
        <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
          <input id="initiator" type="checkbox" />
          <label for="initiator" style="margin:0">I ended the last relationship (applies within first year)</label>
        </div>
      </div>
    </div>

    <!-- Progress -->
    <div class="card">
      <div class="progress"><div id="bar" style="width:0%"></div></div>
      <div class="sub"><span id="count">0</span> / <span id="total">24</span> answered &nbsp;•&nbsp; <span id="pill" class="pill">Incomplete</span></div>
    </div>

    <!-- Questions -->
    <div id="qs" class="card"></div>

    <!-- Results -->
    <div id="results" class="card">
      <div class="flex">
        <div>
          <div class="sub">Score</div>
          <div style="font-size:44px;font-weight:800" id="score">—</div>
          <div class="sub" id="bandL1">Start answering to see your score</div>
          <div class="sub" id="bandL2">—</div>
        </div>
        <div>
          <div class="sub"><strong>Bands</strong></div>
          <ul class="sub" style="margin:6px 0 0 18px">
            <li id="b-ready"></li>
            <li id="b-unsure"></li>
            <li id="b-not"></li>
          </ul>
        </div>
      </div>

      <details style="margin-top:8px">
        <summary>Breakdown</summary>
        <div id="meters" style="margin-top:8px"></div>
      </details>

      <div class="card" style="margin-top:12px">
        <div class="flex">
          <div>
            <strong>Shareable 5-digit code</strong>
            <div class="muted">Encodes your six subscales (bins 1–5).</div>
          </div>
          <button id="copy" class="btn2">Copy</button>
        </div>
        <div style="display:flex;gap:12px;align-items:center;margin-top:6px">
          <span id="code" class="code">00000</span>
          <span class="muted" id="codeNote">Same bins → same code.</span>
        </div>

        <div class="previewWrap">
          <canvas id="badgePreview" width="1080" height="1080" class="blur"></canvas>
        </div>

        <div class="dl-row">
          <span class="sub" style="font-weight:600">Download PNG:</span>
          <button id="dlStory" class="btn2 primary" disabled>Dating apps (1080×1920)</button>
          <button id="dlSquare" class="btn2 primary" disabled>Instagram (1080×1080)</button>
          <button id="dlWide" class="btn2 primary" disabled>Facebook/X (1600×900)</button>
        </div>
        <canvas id="work" width="1080" height="1080" style="display:none"></canvas>
      </div>

      <div id="tips" class="card" style="margin-top:12px">
        <strong>Tips to improve</strong>
        <ul id="tipsList" class="sub" style="margin-top:6px"></ul>
      </div>

      <div class="card" style="margin-top:12px">
        <strong>Save your badge + email</strong>
        <div class="muted">Enter your email and consent. We will try to send a confirmation.</div>
        <div style="display:grid;grid-template-columns:2fr 1fr;gap:8px;align-items:end;margin-top:8px">
          <div>
            <label for="email">Email address</label>
            <input id="email" type="email" placeholder="you@yourdomain.com" />
            <div style="display:flex;gap:8px;align-items:center;margin-top:6px">
              <input id="consent" type="checkbox" />
              <label for="consent" style="margin:0">I agree to receive emails from Ready to Relate.</label>
            </div>
          </div>
          <div>
            <button id="submit" class="btn2 primary" disabled>Save my email</button>
            <div id="msg" class="muted" style="margin-top:6px"></div>
          </div>
        </div>
      </div>
    </div>

    <footer>Built for client-only use. No data leaves your device unless you submit your email.</footer>
  </div>

  <script>
    // ---------- City pack ----------
    const METROS = [
      { id:"NATIONAL", name:"National baseline", ratio:100, marriedPct:51.0 },
      { id:"DET", name:"Detroit, MI", ratio:92.7, marriedPct:22.9 },
      { id:"BOS", name:"Boston, MA", ratio:90.7, marriedPct:29.7 },
      { id:"AUS", name:"Austin, TX", ratio:122.3, marriedPct:40.9 },
      { id:"DC",  name:"Washington, DC", ratio:86.4, marriedPct:32.4 },
      { id:"SJC", name:"San Jose, CA", ratio:123.9, marriedPct:48.1 }
    ];

    // ---------- Config ----------
    const SCALE_MAX = 5;
    const LIKERT = [1,2,3,4,5];
    const WEIGHTS = { intrinsic:1, identified:1, positiveIntrojected:0.5, negativeIntrojected:-0.5, external:-1, amotivation:-1 };
    const BANDS = [
      {key:"ready",   l1:"Ready for relationship", l2:"High overall readiness", min:70, max:100},
      {key:"unsure",  l1:"Unsure but open",        l2:"Moderate overall readiness", min:40, max:69},
      {key:"notready",l1:"Not ready",              l2:"Low overall readiness", min:0,  max:39}
    ];
    const SUB = {
      intrinsic:"Intrinsic", identified:"Identified", positiveIntrojected:"Positive Introjected",
      negativeIntrojected:"Negative Introjected", external:"External", amotivation:"Amotivation"
    };
    const ITEMS = [
      {id:"i1", sub:"intrinsic", text:"Because being in a relationship feels good to me."},
      {id:"i2", sub:"intrinsic", text:"Because I enjoy sharing life with a partner."},
      {id:"i3", sub:"intrinsic", text:"Because close connection is uplifting to me."},
      {id:"i4", sub:"intrinsic", text:"Because a relationship would be fun and fulfilling."},
      {id:"id1",sub:"identified",text:"Because being in a relationship fits my values."},
      {id:"id2",sub:"identified",text:"Because it aligns with who I want to be."},
      {id:"id3",sub:"identified",text:"Because building a relationship matters to me."},
      {id:"id4",sub:"identified",text:"Because commitment is an important life goal for me."},
      {id:"pi1",sub:"positiveIntrojected",text:"Because I would feel proud to be in a relationship."},
      {id:"pi2",sub:"positiveIntrojected",text:"Because it would boost my confidence."},
      {id:"pi3",sub:"positiveIntrojected",text:"Because it would help me feel capable and strong."},
      {id:"pi4",sub:"positiveIntrojected",text:"Because it would make me feel good about myself."},
      {id:"ni1",sub:"negativeIntrojected",text:"Because being single makes me feel not good enough."},
      {id:"ni2",sub:"negativeIntrojected",text:"Because I feel bad about myself when I’m not partnered."},
      {id:"ni3",sub:"negativeIntrojected",text:"Because I’d feel guilty about staying single."},
      {id:"ni4",sub:"negativeIntrojected",text:"Because I’d feel like a loser if I weren’t in a relationship."},
      {id:"e1", sub:"external", text:"Because people close to me expect me to be partnered."},
      {id:"e2", sub:"external", text:"Because it would make family or friends happy."},
      {id:"e3", sub:"external", text:"Because society says I should be in a relationship."},
      {id:"e4", sub:"external", text:"Because I want to avoid others’ judgment about being single."},
      {id:"a1", sub:"amotivation", text:"There is no real reason I want to be in a relationship."},
      {id:"a2", sub:"amotivation", text:"I don’t know why I want a relationship."},
      {id:"a3", sub:"amotivation", text:"I feel indifferent about pursuing a relationship."},
      {id:"a4", sub:"amotivation", text:"I’m not pursuing a relationship for any particular reason."}
    ];

    // ---------- State & DOM ----------
    const answers = {};
    const total = ITEMS.length;
    const el = id => document.getElementById(id);
    const citySel = el("city"); METROS.forEach(m=>{ const o=document.createElement("option"); o.value=m.id; o.textContent=m.name; citySel.appendChild(o); });
    el("total").textContent = String(total);

    // ---------- Helpers ----------
    function clamp(v,min,max){ return Math.max(min,Math.min(max,v)); }
    function ageValid(){
      const a = parseInt(el("age").value||"",10);
      const ok = !isNaN(a) && a>=18 && a<=39;
      el("ageWarn").style.display = ok ? "none":"block";
      return ok;
    }
    function weightedRange(){
      const w=Object.values(WEIGHTS);
      const min=w.reduce((s,wi)=>wi>=0?s+wi*1:s+wi*SCALE_MAX,0);
      const max=w.reduce((s,wi)=>wi>=0?s+wi*SCALE_MAX:s+wi*1,0);
      return {min,max};
    }
    function normalizeTo100(x,min,max){ const pct=(clamp(x,min,max)-min)/(max-min); return Math.round(pct*100); }
    function subAverages(){
      const sums={}, counts={}; Object.keys(WEIGHTS).forEach(k=>{sums[k]=0;counts[k]=0;});
      ITEMS.forEach(it=>{ const v=answers[it.id]; if(typeof v==="number"){ sums[it.sub]+=v; counts[it.sub]++; }});
      const out={}; Object.keys(WEIGHTS).forEach(k=>{ out[k]=counts[k]?sums[k]/counts[k]:0; }); return out;
    }
    function readiness(avgs){
      let raw=0; for(const [k,w] of Object.entries(WEIGHTS)) raw += (avgs[k]||0)*w;
      const {min,max}=weightedRange(); const score=normalizeTo100(raw,min,max);
      let band=BANDS.find(b=>score>=b.min&&score<=b.max)||BANDS[1]; return {score,band};
    }
    function renderMeters(avgs){
      const box=el("meters"); box.innerHTML="";
      Object.keys(WEIGHTS).forEach(k=>{
        const wrap=document.createElement("div"); wrap.style.marginBottom="6px";
        const top=document.createElement("div"); top.className="flex"; top.innerHTML=`<span>${SUB[k]}</span><span class="sub">${(avgs[k]||0).toFixed(2)} / ${SCALE_MAX}</span>`;
        const meter=document.createElement("div"); meter.className="meter";
        const fill=document.createElement("div"); fill.style.width=((avgs[k]||0)/SCALE_MAX*100)+"%";
        meter.appendChild(fill); wrap.appendChild(top); wrap.appendChild(meter); box.appendChild(wrap);
      });
    }
    function updateProgress(){
      const n=Object.keys(answers).length;
      el("count").textContent=String(n);
      el("bar").style.width=Math.round(n/total*100)+"%";
      el("pill").textContent = (n===total && ageValid()) ? "Complete":"Incomplete";
    }

    // ---------- Badge code (same mapping as before) ----------
    const ORDER = ["external","positiveIntrojected","intrinsic","amotivation","identified","negativeIntrojected"];
    const A=42193, B=37489, M=100000;
    function modInv(a,m){ // precomputed INV before; here compute once
      // Fermat little theorem works for prime m, but 100000 isn’t prime. So brute-EEA small loop.
      let [t,newT]=[0,1],[r,newR]=[m,a%m]; while(newR!==0){ const q=Math.floor(r/newR); [t,newT]=[newT,t-q*newT]; [r,newR]=[newR,r-q*newR]; }
      if(r>1) return 1; if(t<0) t+=m; return t;
    }
    const INV = modInv(A,M);

    function makeBadgeCode(avgs){
      const levels = ORDER.map(k=>clamp(Math.round(avgs[k]||0),1,5));
      let idx=0,base=1; for(let i=0;i<ORDER.length;i++){ idx += (levels[i]-1)*base; base*=5; }
      const code=(A*idx + B) % M;
      return { code: String(code).padStart(5,"0"), levels };
    }

    // ---------- Drawing ----------
    const preview = el("badgePreview"), pctx = preview.getContext("2d"), work = el("work");
    function grad(ctx,w,h){ const g=ctx.createLinearGradient(0,0,w,h); g.addColorStop(0,getCSS('--bg1')); g.addColorStop(1,getCSS('--bg2')); ctx.fillStyle=g; ctx.fillRect(0,0,w,h); }
    function getCSS(varName){ return getComputedStyle(document.documentElement).getPropertyValue(varName).trim(); }
    function drawIcon(ctx,variant,w,h){
      ctx.save(); ctx.translate(w/2,h*0.38); ctx.scale(Math.min(w,h)/1000,Math.min(w,h)/1000);
      ctx.lineJoin="round"; ctx.strokeStyle=variant==="low"?"#e07a1f":(variant==="mid"?"#5b43ff":"#06D6A0"); ctx.lineWidth=32; ctx.fillStyle="rgba(255,255,255,0.85)";
      if(variant==="high"){ ctx.beginPath(); for(let i=0;i<10;i++){ const a=i*Math.PI/5; const r=i%2===0?320:150; ctx.lineTo(Math.cos(a)*r,Math.sin(a)*r);} ctx.closePath(); ctx.fill(); ctx.stroke(); }
      else if(variant==="mid"){ ctx.beginPath(); ctx.arc(0,0,300,0,Math.PI*2); ctx.fill(); ctx.stroke(); ctx.beginPath(); ctx.moveTo(-140,0); ctx.lineTo(-20,120); ctx.lineTo(160,-100); ctx.stroke(); }
      else { ctx.beginPath(); ctx.moveTo(0,-320); ctx.lineTo(300,240); ctx.lineTo(-300,240); ctx.closePath(); ctx.fill(); ctx.stroke(); ctx.beginPath(); ctx.moveTo(0,-200); ctx.lineTo(0,80); ctx.stroke(); ctx.beginPath(); ctx.arc(0,160,20,0,Math.PI*2); ctx.fillStyle="#e07a1f"; ctx.fill(); }
      ctx.restore();
    }
    function pickVariant(avgs,score){ if(score>=70 && (avgs.intrinsic||0)>=4 && (avgs.identified||0)>=4 && (avgs.negativeIntrojected||0)<=2.5) return "high"; if(score>=40) return "mid"; return "low"; }
    function drawBadgePreview(avgs,score,band){
      const w=preview.width,h=preview.height; grad(pctx,w,h);
      pctx.fillStyle="#333"; pctx.textAlign="center";
      pctx.font=Math.floor(h*0.06)+"px Inter, sans-serif"; pctx.fillText("Ready to Relate", w/2, h*0.12);
      const variant=pickVariant(avgs,score||0); drawIcon(pctx,variant,w,h);
      pctx.font=Math.floor(h*0.08)+"px Inter, sans-serif"; pctx.fillText(score==null?"—":String(score), w/2, h*0.6);
      pctx.font=Math.floor(h*0.04)+"px Inter, sans-serif"; pctx.fillText(band||"—", w/2, h*0.66);
      const {code}=makeBadgeCode(avgs);
      const chipW=pctx.measureText(code).width+48, chipH=Math.floor(h*0.05)+18, chipX=(w-chipW)/2, chipY=h*0.78-chipH/2;
      pctx.fillStyle="rgba(255,255,255,0.9)"; pctx.strokeStyle="#06D6A0"; pctx.lineWidth=3; const r=14;
      pctx.beginPath(); pctx.moveTo(chipX+r,chipY); pctx.lineTo(chipX+chipW-r,chipY); pctx.quadraticCurveTo(chipX+chipW,chipY,chipX+chipW,chipY+r);
      pctx.lineTo(chipX+chipW,chipY+chipH-r); pctx.quadraticCurveTo(chipX+chipW,chipY+chipH,chipX+chipW-r,chipY+chipH);
      pctx.lineTo(chipX+r,chipY+chipH); pctx.quadraticCurveTo(chipX,chipY+chipH,chipX,chipY+chipH-r);
      pctx.lineTo(chipX,chipY+r); pctx.quadraticCurveTo(chipX,chipY,chipX+r,chipY); pctx.closePath(); pctx.fill(); pctx.stroke();
      pctx.fillStyle="#333"; pctx.font=Math.floor(h*0.04)+"px Inter, sans-serif"; pctx.fillText(code, w/2, h*0.80 + chipH/3);
      pctx.font=Math.floor(h*0.025)+"px Inter, sans-serif"; pctx.fillText("readytorelate.com", w/2, h*0.92);
    }
    function drawBadgeToCanvas(target,avgs,score,band){
      const ctx=work.getContext("2d"); let w=1080,h=1080,file="rfr_instagram.png";
      if(target==="story"){ w=1080; h=1920; file="rfr_dating_apps.png"; }
      if(target==="wide"){ w=1600; h=900; file="rfr_facebook_x.png"; }
      work.width=w; work.height=h; grad(ctx,w,h);
      ctx.fillStyle="#333"; ctx.textAlign="center";
      ctx.font=Math.floor(h*0.06)+"px Inter, sans-serif"; ctx.fillText("Ready to Relate", w/2, h*0.12);
      drawIcon(ctx,pickVariant(avgs,score),w,h);
      ctx.font=Math.floor(h*0.08)+"px Inter, sans-serif"; ctx.fillText(String(score), w/2, h*0.6);
      ctx.font=Math.floor(h*0.04)+"px Inter, sans-serif"; ctx.fillText(band, w/2, h*0.66);
      const {code}=makeBadgeCode(avgs);
      const chipW=ctx.measureText(code).width+48, chipH=Math.floor(h*0.05)+18, chipX=(w-chipW)/2, chipY=h*0.78-chipH/2;
      ctx.fillStyle="rgba(255,255,255,0.9)"; ctx.strokeStyle="#06D6A0"; ctx.lineWidth=3; const r=14;
      ctx.beginPath(); ctx.moveTo(chipX+r,chipY); ctx.lineTo(chipX+chipW-r,chipY); ctx.quadraticCurveTo(chipX+chipW,chipY,chipX+chipW,chipY+r);
      ctx.lineTo(chipX+chipW,chipY+chipH-r); ctx.quadraticCurveTo(chipX+chipW,chipY+chipH,chipX+chipW-r,chipY+chipH);
      ctx.lineTo(chipX+r,chipY+chipH); ctx.quadraticCurveTo(chipX,chipY+chipH,chipX,chipY+chipH-r);
      ctx.lineTo(chipX,chipY+r); ctx.quadraticCurveTo(chipX,chipY,chipX+r,chipY); ctx.closePath(); ctx.fill(); ctx.stroke();
      ctx.fillStyle="#333"; ctx.font=Math.floor(h*0.04)+"px Inter, sans-serif"; ctx.fillText(code, w/2, h*0.80 + chipH/3);
      const url=work.toDataURL("image/png"); const a=document.createElement("a"); a.href=url; a.download=file; document.body.appendChild(a); a.click(); a.remove();
    }

    // ---------- Render questions ----------
    function renderQs(){
      const holder=el("qs"); holder.innerHTML="";
      const shuffled = ITEMS.slice().sort(()=>Math.random()-0.5);
      shuffled.forEach(it=>{
        const row=document.createElement("div"); row.className="row";
        const q=document.createElement("div"); q.className="q"; q.textContent=it.text; row.appendChild(q);
        const g=document.createElement("div"); g.className="grid5";
        LIKERT.forEach(v=>{
          const b=document.createElement("button"); b.className="btn"; b.textContent=String(v);
          b.title = ["Strongly disagree","Disagree","Neutral","Agree","Strongly agree"][v-1];
          b.addEventListener("click",()=>{ answers[it.id]=v; Array.from(g.children).forEach(c=>c.classList.remove("sel")); b.classList.add("sel"); update(); });
          g.appendChild(b);
        });
        row.appendChild(g); holder.appendChild(row);
      });
    }

    // ---------- Tips ----------
    function tipsFor(score){
      if(score>=70) return [
        "Keep values-aligned actions.",
        "Protect time for fun. Joy fuels bonding."
      ];
      if(score>=40) return [
        "Pick one weekly action that fits your values.",
        "Swap one 'should' with one concrete step."
      ];
      return [
        "Start small: one message to a friend today.",
        "List 3 partner qualities and 3 strengths."
      ];
    }

    // ---------- Update everything ----------
    function update(){
      updateProgress();
      const avgs=subAverages();
      const {score,band}=readiness(avgs);
      const any=Object.keys(answers).length>0;
      el("score").textContent = any ? String(score) : "—";
      el("bandL1").textContent = any ? band.l1 : "Start answering to see your score";
      el("bandL2").textContent = any ? band.l2 : "—";
      el("b-ready").textContent = `Ready: ${BANDS[0].min}–${BANDS[0].max}`;
      el("b-unsure").textContent = `Unsure: ${BANDS[1].min}–${BANDS[1].max}`;
      el("b-not").textContent = `Not ready: ${BANDS[2].min}–${BANDS[2].max}`;
      renderMeters(avgs);

      const {code}=makeBadgeCode(avgs); el("code").textContent = code;
      const complete = (Object.keys(answers).length===total) && ageValid();
      preview.classList.toggle("blur", !complete);
      el("dlStory").disabled = !complete; el("dlSquare").disabled = !complete; el("dlWide").disabled = !complete;

      // Tips
      el("tipsList").innerHTML = any ? tipsFor(score).map(t=>`<li>${t}</li>`).join("") : "";

      // Draw preview
      drawBadgePreview(avgs, any?score:null, any?band.l1:null);

      // Enable submit if email + consent + complete
      enableSubmit();
    }

    // ---------- Interactions ----------
    function emailValid(v){ return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(String(v||"").trim()); }
    function enableSubmit(){
      const ok = (Object.keys(answers).length===total) && ageValid() && emailValid(el("email").value) && el("consent").checked;
      el("submit").disabled = !ok;
    }

    el("age").addEventListener("input", ()=>{ ageValid(); update(); });
    el("city").addEventListener("change", update);
    el("pool").addEventListener("change", update);
    el("months").addEventListener("input", update);
    el("initiator").addEventListener("change", update);

    el("copy").addEventListener("click", async ()=>{
      try { await navigator.clipboard.writeText(el("code").textContent); const old=el("copy").textContent; el("copy").textContent="Copied"; setTimeout(()=>el("copy").textContent=old,1000);} catch(_){}
    });

    el("dlStory").addEventListener("click", ()=>{ const av=subAverages(); const r=readiness(av); drawBadgeToCanvas("story",av,r.score,r.band.l1); });
    el("dlSquare").addEventListener("click", ()=>{ const av=subAverages(); const r=readiness(av); drawBadgeToCanvas("square",av,r.score,r.band.l1); });
    el("dlWide").addEventListener("click", ()=>{ const av=subAverages(); const r=readiness(av); drawBadgeToCanvas("wide",av,r.score,r.band.l1); });

    el("email").addEventListener("input", enableSubmit);
    el("consent").addEventListener("change", enableSubmit);

    el("submit").addEventListener("click", async ()=>{
      const msg=el("msg"); msg.textContent="Saving…";
      const avgs=subAverages(); const {code}=makeBadgeCode(avgs);
      const body = { email: (el("email").value||"").trim(), city: (el("city").value||"").trim(), badge: code, consent: true, sessionId: crypto.randomUUID ? crypto.randomUUID() : (Math.random().toString(36).slice(2)+Date.now().toString(36)), referrer: document.referrer };
      try{
        const resp = await fetch("/api/badge", { method:"POST", headers:{ "content-type":"application/json" }, body: JSON.stringify(body) });
        let payload=null; try{ payload = await resp.json(); }catch(_){}
        if(resp.ok){
          if(payload && payload.sent){ msg.innerHTML = '<span class="ok">Saved. Check your inbox for confirmation.</span>'; }
          else { msg.innerHTML = '<span class="ok">Saved.</span> <span class="muted">Confirmation email could not be sent right now.</span>'; }
        } else {
          const txt = payload ? JSON.stringify(payload) : await resp.text().catch(()=> "");
          msg.innerHTML = `<span class="err">Could not save (${resp.status}). ${txt||""}</span>`;
          el("submit").disabled = false;
        }
      }catch(e){
        msg.innerHTML = '<span class="err">Something went wrong. Please try again.</span>';
        el("submit").disabled = false;
      }
    });

    // ---------- Boot ----------
    (function boot(){
      renderQs(); update();
    })();
  </script>
</body>
</html>
